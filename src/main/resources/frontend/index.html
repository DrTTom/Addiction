<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Dependency Graph</title>
    <script src="vis.min.js"></script>
    <link href="vis.min.css" rel="stylesheet" type="text/css"/>
    <script src="lodash.all.min.js"></script>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }

        button {
            background-color: #74894f;
            border: none;
            color: white;
            padding: 5px 10px;
            margin-top: 5px;
            margin-right: 5px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }
        .row {        
        display: flex;
        }
     .left {
          flex: 40%;
		}
       .right {
    	      flex: 60%;
}
        #mynetwork {
            width: 700px;
            height: 700px;
            border: 1px solid lightgray;
            float: left;
            margin-right: 10px;
        }
    </style>
</head>
<body>

<script type="text/html" id="nodeInfo">
    <h3><%=type%> <%=name%></h3>
    <% if(typeof resourceType != 'undefined'){ %>
    <div class="row">
        <div class="left">found in:</div>
        <div class="right"><%=resourceType%> <%=resourceName%></div>
    </div>
    <% } %>
    <div class="row">
        <div class="left">total number classes:</div>
        <div class="right"><%=numberContainedClasses%></div>
    </div>
    <div class="row">
        <div class="left">current reference:</div>
        <div class="right"><%=id%></div>
    </div>
    <% if(type!='class'){ %>
        <button id="expandNode" change-list-mode="EXPANDED">expand <%=numberExpandable %> nodes</button>
    <% } %>
    <% if(type=='class' || type=='package' || type =='package tree'){ %>
        <button id="collapseParentNode" change-list-mode="COLLAPSE_PARENT">collapse <%=numberCollapsable %> nodes into parent container</button>
    <% } %>
</script>

<script type="text/html" id="refReportTmpl">
    <h2>References Report</h2>
    <h3>Unreferenced classes</h3>    
    <% if(classes.length==0) { %>
    There are no apparently unused classes.
    <% } else { %>
    The following classes appear to be unused, consider to removing them from your project:
    <p>    
    <% for(var i = 0; i < classes.length; ++i) {%>
      <%=classes[i] %></br> 
    <% } %>
	</p> 
    <% } %>
    <h3>Unreferenced libraries</h3>
    <% if(jars.length==0) { %>
    Your class path looks correct.
    <% } else { %>
    Your class path contains jars which are not used statically. Run your tests to find out whether they are really needed:
    <p>    
    <% for(var i = 0; i < jars.length; ++i) {%>
      <%=jars[i] %></br> 
    <% } %>
	</p> 
    <% } %>
    <h3>Libraries used by few classes</h3>
    <h3>Libraries providing few classes</h3>
</script>

<h1>Dependency graph of project <span id="projectName"></span></h1>

<div id="mynetwork"></div>
<div id="detailInfo">
    <h2>Graph</h2>
    <h3>Nodes</h3>
    <button onClick="setFilter('resetListMode')">reset node set</button>
    <button onClick="distribute()">distribute</button>
    <br>
    <h3>Filters</h3>
    <button onClick="setFilter('none')">whole graph</button>
    <button onClick="setFilter('cycles')">cycles only</button>
    <br/>
    <button onClick="impliedOnly(true)">required by selected node</button>
    <button onClick="impliedOnly(false)">requiring selected node</button>
    <h2>Selected Element</h2>
    <div id="description"></div>
</div>
<div style="width: 100%; float: left">
<div id="refReport"></div>
    <h2>Classpath</h2>
    <form action="" id="classpath">
    </form>    
</div>

<script>
    var network;
    var selectedNode = '';

    get("http://localhost:4567/view/name", function (name) {
        document.getElementById('projectName').innerHTML = name
    });
    get("http://localhost:4567/view", showGraph);
    get("http://localhost:4567/view/classpath", showPath);
    get("http://localhost:4567/view/unrefReport", showReport);

    function showPath(value) {
        var response = JSON.parse(value);
        var list = "";
        response.forEach(function (entry) {
            list = list + "<input type='checkbox' enabled='false' checked='checked' disabled='true'/>" + entry + '<br>';
        });
        document.getElementById('classpath').innerHTML = list;
    }

    function showReport(value) {
        var report = JSON.parse(value);
        const tplInfo = _.template(document.getElementById('refReportTmpl').innerHTML);
        const reportDiv = document.getElementById('refReport');
        reportDiv.innerHTML = tplInfo(report);
    }

    function get(url, callBack) {
        var req = new XMLHttpRequest();
        req.open('GET', url, true);
        req.send();
        req.onreadystatechange = function (e) {
            if (req.readyState == 4) {
                callBack(req.responseText);
            }
        }
    }
	var zoomEnabled=true;
    function showGraph(responseText) {
        var response = JSON.parse(responseText);
        var nodes = new vis.DataSet(response.nodes);
        var edges = new vis.DataSet(response.edges);

        var container = document.getElementById('mynetwork');
        var data = {
            nodes: nodes,
            edges: edges
        };
        var gray = '#555555'
        var options = { 
        		physics: false,
        		interaction: {hover: true},
        		 groups: {
        			 'jar': {
     	            	color: {background:'#e7a5ab',border:gray, hover:{background:'#ebb5ba',border:'black'}, highlight:{background:'#ebb5ba',border:'black'}},        	               
     	            },
     	           'dir': {
   	            	color: {background:'#afd6e7',border:gray, hover:{background:'#dbecf4',border:'black'}, highlight:{background:'#dbecf4',border:'black'}},        	               
   	            },
        	            'package': {
        	            	color: {background:'#aec489',border:gray, hover:{background:'#d2debe',border:'black'}, highlight:{background:'#d2debe',border:'black'}},
        	            },
        	            'class': {
        	            	color: {background:'#ffed9e',border:gray, hover:{background:'#fff5ca',border:'black'}, highlight:{background:'#fff5ca',border:'black'}}
        	            }
        	            
        	        }
        };
        network = new vis.Network(container, data, options);
        selectedNode = '';
        document.getElementById('description').innerHTML = "Click on node or arc to select it."
        zoomEnabled=false;
        distribute();
        network.on("stabilized", function (params) {
            network.setOptions({
                physics: false
            });
            zoomEnabled=true;
        });

        network.on("initRedraw" , function (params) {
            if (!zoomEnabled) {network.fit();}
        });
        network.on("click", function (params) {
            selectedNode = '';
            params.event = "[original event]";
            if (params.nodes.length == 1) {
                getNodeInfo(params.nodes[0]);
            } else if (params.edges.length == 1) {
                getArcInfo(params.edges[0]);
            } else document.getElementById('description').innerHTML = "nothing selected";
        });
    }

    function distribute() {
        network.setOptions({
            physics: true
        });
    }

    function getNodeInfo(id) {
        get("http://localhost:4567/view/node/" + id, function (e) {
            var nodeInfo = JSON.parse(e);
            nodeInfo.id=id;
            
            selectedNode = id
            const tplInfo = _.template(document.getElementById('nodeInfo').innerHTML);
            const description = document.getElementById('description');
            description.innerHTML = tplInfo(nodeInfo);
            Array.from(description.querySelectorAll('button')).forEach(button=>{
                button.addEventListener('click', function(evt){
                    console.log(evt.target);
                    const mode = evt.target.getAttribute('change-list-mode');
                    changeListMode(mode)
                })
            })
        });
    }

    function changeListMode(mode) {
        if (selectedNode != '') {
            get("http://localhost:4567/view/node/" + selectedNode + "/listmode/" + mode, showGraph);
        }
    }

    function setFilter(value) {
        get("http://localhost:4567/view/filters/" + value, showGraph);
    }

    function impliedOnly(value)
    {
        get("http://localhost:4567/view/filters/impliedBy/"+selectedNode+"/" + value, showGraph);
    }

    function getArcInfo(id) {
        get("http://localhost:4567/view/arc/" + id, function (e) {
            var arcInfo = JSON.parse(e);
            var description = '<h3>' + arcInfo.from.name + ' depends on ' + arcInfo.to.name +
                '</h3> Reason: <table>';
            arcInfo.reason.forEach(function (pair) {
                description = description + '<tr><td>' + pair.first + '</td><td> depends on </td><td>' + pair.second + '</td></tr>'
            });

            document.getElementById('description').innerHTML = description + '</table>';
        });
    }
</script>

</body>
</html>
